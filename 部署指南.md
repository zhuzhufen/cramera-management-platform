# 相机租赁管理平台部署指南

## 镜像构建完成

已构建两个架构的Docker镜像：

### ARM架构镜像（适用于Apple Silicon等ARM设备）
- 镜像名称：`camera-rental-platform:latest`
- 镜像大小：220MB
- 构建时间：2025-10-01

### x86架构镜像（适用于Intel/AMD服务器）
- 镜像名称：`camera-rental-platform:x86-latest`
- 镜像大小：53MB
- 构建时间：2025-10-01

## x86平台部署说明

如果您要在x86架构的服务器上部署，请使用x86版本的镜像：

### 导出x86镜像
```bash
# 导出x86架构镜像
docker save -o camera-rental-platform-x86.tar camera-rental-platform:x86-latest
```

### 修改docker-compose.yml使用x86镜像
```yaml
services:
  camera-rental-app:
    image: camera-rental-platform:x86-latest  # 使用x86版本
    container_name: camera_rental_app
    environment:
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-camera_rental_management}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-123456}
      NODE_ENV: production
    ports:
      - "3000:3000"
    restart: unless-stopped
```

## 部署到另一台服务器

### 1. 导出镜像文件

在当前机器上导出镜像：

```bash
# 将镜像保存为tar文件
docker save -o camera-rental-platform.tar camera-rental-platform:latest
```

### 2. 传输镜像到目标服务器

将导出的tar文件传输到目标服务器：

```bash
# 使用scp传输（替换your_server为实际服务器地址）
scp camera-rental-platform.tar user@your_server:/path/to/destination/
```

### 3. 在目标服务器上加载镜像

在目标服务器上执行：

```bash
# 加载镜像
docker load -i camera-rental-platform.tar

# 验证镜像加载成功
docker images | grep camera-rental-platform
```

### 4. 配置数据库连接

在目标服务器上创建环境变量文件 `.env`：

```bash
# 创建.env文件
cat > .env << EOF
# 数据库连接配置 - 请根据您的实际数据库信息修改
DB_HOST=your_database_host
DB_PORT=5432
DB_NAME=camera_rental_management
DB_USER=your_database_user
DB_PASSWORD=your_database_password

# 应用配置
NODE_ENV=production
EOF
```

### 5. 创建docker-compose.yml文件

在目标服务器上创建docker-compose.yml文件：

```yaml
services:
  camera-rental-app:
    image: camera-rental-platform:latest
    container_name: camera_rental_app
    environment:
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-camera_rental_management}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-123456}
      NODE_ENV: production
    ports:
      - "3000:3000"
    restart: unless-stopped
```

**重要提示**：不要使用 `build: .`，因为Dockerfile不会传输到目标服务器，应该使用已经构建好的镜像。

### 6. 启动应用

```bash
# 使用docker-compose启动应用
docker-compose up -d

# 查看运行状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

## 数据库连接配置说明

### 需要修改的配置项

在 `.env` 文件中，您需要修改以下数据库连接信息：

- **DB_HOST**: 数据库服务器地址（IP或域名）
- **DB_PORT**: 数据库端口（默认5432）
- **DB_NAME**: 数据库名称（默认camera_rental_management）
- **DB_USER**: 数据库用户名
- **DB_PASSWORD**: 数据库密码

### 配置示例

```bash
# 示例配置 - 请替换为您的实际配置
DB_HOST=192.168.1.100
DB_PORT=5432
DB_NAME=camera_rental_management
DB_USER=myuser
DB_PASSWORD=mypassword123
```

### 数据库要求

确保目标数据库已经创建并包含以下表结构：
- users (用户表)
- cameras (相机表) 
- customers (客户表)
- rentals (租赁记录表)

## 验证部署

1. 访问应用：`http://服务器IP:3000`
2. 使用默认管理员账户登录：
   - 用户名：admin
   - 密码：admin123

## 常用命令

```bash
# 停止应用
docker-compose down

# 重启应用
docker-compose restart

# 查看应用日志
docker-compose logs camera-rental-app

# 进入容器
docker exec -it camera_rental_app sh

# 备份数据库（如果数据库在同一服务器）
docker exec -it camera_rental_db pg_dump -U postgres camera_rental_management > backup.sql
```

## 故障排除

1. **应用无法启动**：检查数据库连接配置是否正确
2. **数据库连接失败**：确认数据库服务器可访问，防火墙设置正确
3. **端口冲突**：修改docker-compose.yml中的端口映射
4. **查看详细日志**：使用 `docker-compose logs -f` 查看实时日志

## 安全建议

1. 在生产环境中修改默认密码
2. 使用HTTPS加密传输
3. 定期备份数据库
4. 监控应用运行状态
